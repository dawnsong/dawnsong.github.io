<!DOCTYPE html> <html lang="cn"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> 离线 | Robust </title> <meta name="author" content="Xiaowei Song"> <meta name="description" content="play when my data runs out"> <meta name="keywords" content="robust, big data, MRI, cryoET, cryoEM, healthcare"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://dawnsong.github.io/digests/offline/"> <script src="/assets/js/theme.js?709e0f78aaa8187780f714018a77f74f"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> <link rel="stylesheet" href="/assets/node_modules/aplayer/dist/xAPlayer.min.css"> <script src="/assets/node_modules/aplayer/dist/APlayer.min.js"></script> <script src="/assets/node_modules/js-cookie/dist/js.cookie.min.js"></script> <script src="/hifini/xhifini.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Robust </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item active"> <a class="nav-link" href="/digests/">Digests <span class="sr-only">(current)</span> </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Other </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> <a class="dropdown-item " href="/publications/?x=100">publications</a> <a class="dropdown-item " href="/projects/">projects</a> <a class="dropdown-item " href="/news/">news</a> <a class="dropdown-item " href="/repositories/">repos</a> <a class="dropdown-item " href="/people/">people</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/digests/offline/?playlist=offline&amp;x=100&amp;r=1">offline</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">离线</h1> <p class="post-description">play when my data runs out</p> </header> <article> <div class="row"> <div class="col-sm mt-3 mt-md-0" id="cover4yiGongZi"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/yiGongZi_suShi/%E6%84%8F%E5%85%AC%E5%AD%90%E8%AC%9B%E8%98%87%E8%BB%BE_001__%E8%98%87%E6%9D%B1%E5%9D%A1%E5%BC%8F%E7%9A%84%E8%87%AA%E5%98%B2%EF%BC%9A%E6%B4%BB%E8%91%97%E7%9A%84%E6%84%8F%E7%BE%A9%EF%BC%8C%E4%B9%9F%E8%A8%B1%E6%98%AF%E9%82%A3%E4%BA%9B%E6%B8%A1%E9%81%8E%E4%BA%BA%E7%94%9F%E4%BD%8E%E8%B0%B7%E6%99%82%E7%9A%84%E7%B6%93%E6%AD%B7%E3%80%90%E6%84%8F%E5%85%AC%E5%AD%90%E3%80%91-mJyZ8-o4gsg-480.webp 480w,/assets/img/yiGongZi_suShi/%E6%84%8F%E5%85%AC%E5%AD%90%E8%AC%9B%E8%98%87%E8%BB%BE_001__%E8%98%87%E6%9D%B1%E5%9D%A1%E5%BC%8F%E7%9A%84%E8%87%AA%E5%98%B2%EF%BC%9A%E6%B4%BB%E8%91%97%E7%9A%84%E6%84%8F%E7%BE%A9%EF%BC%8C%E4%B9%9F%E8%A8%B1%E6%98%AF%E9%82%A3%E4%BA%9B%E6%B8%A1%E9%81%8E%E4%BA%BA%E7%94%9F%E4%BD%8E%E8%B0%B7%E6%99%82%E7%9A%84%E7%B6%93%E6%AD%B7%E3%80%90%E6%84%8F%E5%85%AC%E5%AD%90%E3%80%91-mJyZ8-o4gsg-800.webp 800w,/assets/img/yiGongZi_suShi/%E6%84%8F%E5%85%AC%E5%AD%90%E8%AC%9B%E8%98%87%E8%BB%BE_001__%E8%98%87%E6%9D%B1%E5%9D%A1%E5%BC%8F%E7%9A%84%E8%87%AA%E5%98%B2%EF%BC%9A%E6%B4%BB%E8%91%97%E7%9A%84%E6%84%8F%E7%BE%A9%EF%BC%8C%E4%B9%9F%E8%A8%B1%E6%98%AF%E9%82%A3%E4%BA%9B%E6%B8%A1%E9%81%8E%E4%BA%BA%E7%94%9F%E4%BD%8E%E8%B0%B7%E6%99%82%E7%9A%84%E7%B6%93%E6%AD%B7%E3%80%90%E6%84%8F%E5%85%AC%E5%AD%90%E3%80%91-mJyZ8-o4gsg-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/yiGongZi_suShi/%E6%84%8F%E5%85%AC%E5%AD%90%E8%AC%9B%E8%98%87%E8%BB%BE_001__%E8%98%87%E6%9D%B1%E5%9D%A1%E5%BC%8F%E7%9A%84%E8%87%AA%E5%98%B2%EF%BC%9A%E6%B4%BB%E8%91%97%E7%9A%84%E6%84%8F%E7%BE%A9%EF%BC%8C%E4%B9%9F%E8%A8%B1%E6%98%AF%E9%82%A3%E4%BA%9B%E6%B8%A1%E9%81%8E%E4%BA%BA%E7%94%9F%E4%BD%8E%E8%B0%B7%E6%99%82%E7%9A%84%E7%B6%93%E6%AD%B7%E3%80%90%E6%84%8F%E5%85%AC%E5%AD%90%E3%80%91-mJyZ8-o4gsg.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="yiGongZi_suShi" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Current playing episode. </div> <details><summary>Manage local indexedDB cached MP3s</summary> <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> <link rel="stylesheet" href="https://cdn.datatables.net/2.3.5/css/dataTables.dataTables.css"> <script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script> <script src="https://cdn.datatables.net/select/3.1.3/js/dataTables.select.js"></script> <script src="https://cdn.datatables.net/select/3.1.3/js/select.dataTables.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script> <div id="divTbl4idb"> <table id="tbl4idb" class="stripe row-border order-column" cellspacing="0" width="100%"> <thead> <tr> <th></th> <th>artist</th> <th>name</th> <th>mimeType</th> <th>size</th> <th>timestamp</th> </tr> </thead> </table> </div> </details> <script defer>
function waitForElement(selector, callback) {
  const observer = new MutationObserver((mutations, obs) => {
    const element = document.querySelector(selector);
    if (element) {
      obs.disconnect(); // Stop observing once the element is found
      callback(element);
    }
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  }); // Observe changes in the entire body
}
// Example usage:
waitForElement('#xplayer', (divElement) => {
  console.log('xplayer exists:', divElement);  
  // Perform actions on divElement
});
// // Simulate dynamic element creation
// setTimeout(() => {
//   const newDiv = document.createElement('div');
//   newDiv.id = 'myDynamicDiv';
//   newDiv.textContent = 'This is a dynamically added div.';
//   document.body.appendChild(newDiv);
// }, 1500);
//------------------------------------------------------------------------------

async function idb2dataArray(idb, storeName){
  return new Promise((resolve, reject) => {
    const transaction = idb.transaction([storeName], "readonly");
    const objectStore = transaction.objectStore(storeName);
    const allRecords = [];
    objectStore.openCursor().onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor) {
        let oneRow=cursor.value;
        //get basename and remove ext, i.e., get the stem
        let stem=oneRow['fileName'].split('/').pop().replace(/\.[^/.]+$/, '');
        oneRow['artist']=stem.split('__')[0];
        oneRow['name']=stem.split('__')[1];
        oneRow['size']=formatAsByteString(oneRow['size']);
        allRecords.push(oneRow);
        cursor.continue();
      } else {
        // All records have been retrieved, now convert to JSON
        try {
          // const jsonString = JSON.stringify(allRecords, null, 2); // null, 2 for pretty printing
          // resolve(jsonString);
          resolve(allRecords);
        } catch (error) {
          reject(`Error converting allRecords to JSON: ${error}`);
        }
      }
    };
    transaction.onerror = (event) => {
      reject(`Transaction error: ${event.target.errorCode}`);
    }; 
  });
}

function updateCoverImg(rIdx){
  let srcSet=document.querySelector(".responsive-img-srcset");//only need to change the responsive source set!        
  let currentSong=ap.list.audios[rIdx];
  if(srcSet && currentSong &&  currentSong.cover){
    srcSet.srcset=currentSong.cover;
    let divCaption=document.querySelector("div.caption");
    divCaption.innerHTML   =`<p style='text-align: center;'>${currentSong.name}<br>${currentSong.artist}</p>`;
  }
}

const currentUrl = new URL(window.location.href);
const params = currentUrl.searchParams;
let cpPlaylist=params.get('playlist') ;
cpPlaylist=cpPlaylist !== null ? cpPlaylist : 'random';
console.log(cpPlaylist);
if(cpPlaylist=='random'){//no param has been passed yet to set the xPlayer
    params.set('playlist','offline');
    params.set('x','100');
    params.set('r','1');
    currentUrl.search = params.toString();
    console.log(currentUrl);
    window.location.href = currentUrl.toString();    
}else{
    console.log(params)
    setTimeout(async () => {
        console.log(`ap: ${ap}`) ;
        ap.audio.addEventListener('play', async function(){             
            updateCoverImg(ap.list.index);
        });
        //list cached songs to the table
        if(typeof idb4songs !== 'undefined' && idb4songs!==null){
          if(typeof storeName === 'undefined')throw(`storeName cannot be found!!!`);
          let data4tbl=await idb2dataArray(idb4songs, storeName);
          // console.log(data4tbl);  
          renderData2table(data4tbl);
        }
        //randomly init the cover image since the default expiring days is 7 in google storage
        rIdx=Math.floor(Math.random() * 39);
        updateCoverImg(rIdx);
    }, 3000); //allow 3 seconds delay/timeout to check if ap is loaded    
}

let dt=null, dt4desc=null;
function rmKey(key) {
  return new Promise((resolve, reject) => {
    if (!idb4songs) {
      reject(new Error('Database not initialized.'));
      return;
    }
    // 1. Initiate a read-write transaction
    const transaction = idb4songs.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    // 2. Request to delete the specific key
    const request = store.delete(key);
    request.onerror = (event) => {
      console.error('Error deleting key:', event.target.error);
      reject(event.target.error);
    };
    request.onsuccess = (event) => {
      console.log(`Key '${key}' deleted successfully.`);
      resolve();
    };
  });
}
function renderData2table(arr4tb){ 
  if(dt!==null) {dt.destroy();}//restore to simple html table, still kept in DOM
  if(typeof ap == 'undefined')return;
  // Initialise the DataTable
  dt=new DataTable('#tbl4idb', {
    columnDefs: [
        {//checkbox for the 1st select col
            orderable: false,
            render: DataTable.render.select(),
            targets: 0,
            searchable: false            
        }
    ],
    columns: [{data:0}, { data: 'artist' },{ data: 'name' }, { data: 'mimeType' }, { data: 'size' }, 
      { data: 'timestamp', render: function (data, type, row) {
        if (type === 'display' || type === 'filter') {
            // Assuming 'data' is a timestamp in milliseconds
            // const date = new Date(data);//traditional JS way
            // const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            // return date.toLocaleDateString('en-US', options); 
            return moment(data).format('YYYYMMDD HH:mm');
        }
        return data; // For sorting and other types, return original data
      }}],
    data: arr4tb,
    // layout: {
    //   topStart: { }
    // },
    order: [[4, 'desc']],
    // select: true
    select: {
        style: 'os',
        selector: 'td:first-child'
    }
  });
  //make a `rm` btn to rm selected rows
  const btnRm = document.createElement('button');
  btnRm.textContent ="RM Selected ... ";
  btnRm.id='btnRm';
  btnRm.classList.add("dt-button");
  dtSearchParentDiv=document.querySelector("#divTbl4idb .dt-layout-cell.dt-end");
  dtSearchParentDiv.insertBefore(btnRm, dtSearchParentDiv.firstChild);
  
  btnRm.addEventListener('click', async () => {    
    var selectedRowsData = dt.rows({ selected: true }).data();
    // Iterate through the selected rows' data
    selectedRowsData.each(async function(rowData) {
        console.log(rowData); // rowData will contain the data for each selected row        
        // if(await keyExists(rowData['fileName'])>0){
        await rmKey(rowData['fileName']);
        // }
    });
    //reload the data
    let data4tbl=await idb2dataArray(idb4songs, storeName);          
    renderData2table(data4tbl);
  });  

  const btnPlaySelected= document.createElement('button');
  btnPlaySelected.textContent ="Play Selected";  
  btnPlaySelected.classList.add("dt-button");  
  dtSearchParentDiv.insertBefore(btnPlaySelected, dtSearchParentDiv.firstChild);
  btnPlaySelected.addEventListener('click', async () => { 
    ap.list.clear();
    var selectedRowsData = dt.rows({ selected: true }).data();    
    selectedRowsData.each(async function(rowData) {
      aBlob=await loadAudioBlob(rowData['fileName']); 
      if(aBlob != null )
      if('meta' in rowData)
        ap.list.add([{"name":rowData['name'], "artist":rowData['artist'], "url":URL.createObjectURL(aBlob.data), "cover":rowData['meta']["cover"]}]);
      else
        ap.list.add([{"name":rowData['name'], "artist":rowData['artist'], "url":URL.createObjectURL(aBlob.data)}]);
    });    
  });
}

async function renderSuShi(){
  let data4suShi=await json2array('/hifini/yiGongZi/suShi-desc.json');
  console.log(data4suShi);
  let dt4desc=new DataTable('#tbl4desc', {
    columnDefs: [
        {//checkbox for the 1st select col
            orderable: false,
            render: DataTable.render.select(),
            targets: 0,
            searchable: false            
        }
    ],
    columns: [{data:0}, { data: 'index' },{ data: 'desc' }],
    order: [[1, 'asc']],
    data: data4suShi,    
    // select: true
    select: {
        style: 'os',
        selector: 'td:first-child'
    }
  });
}
// setTimeout(async () => { await renderSuShi(); }, 5000);

</script> <blockquote> </blockquote> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> <div id="xplayer" style="text-align: left;"></div> <script type="text/javascript" src="https://storage.googleapis.com/xpub/playlists/json.js" defer></script> <script type="text/javascript" src="/hifini/xplayer.js" defer></script> Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> | <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a>. <b id="idbQuotaUsed"></b>|<b id="idbQuotaTotal"></b> © Copyright 2025 Xiaowei Song. Last updated: December 15, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?c29fd54348398a9a75966ef9a8e5d84b"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?2b177038d0885a876f47a3df6474238a" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-BYFL6HDBJH"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-BYFL6HDBJH');
  </script> <script defer src="/assets/js/google-analytics-setup.js"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>