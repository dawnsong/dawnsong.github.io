"use strict";function randomInt(o,e){return Math.floor(Math.random()*(e-o+1)+o)}async function json2array(o){try{const e=await fetch(o);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}catch(o){throw console.error("Fetching JSON failed:",o),o}}function getParam(o,e){const t=new URLSearchParams(window.location.search).get(o);return null!==t?t:e}function getRandomSubarray(o,e){e>o.length&&(e=o.length);for(var t,n,r=o.slice(0),a=o.length,s=a-e;a-- >s;)t=r[n=Math.floor((a+1)*Math.random())],r[n]=r[a],r[a]=t;return r.slice(s)}function moveDivToUl(){$("div.page__footer-follow > ul.social-icons > li:nth-child(1)").css("color","red")}function safeObjClick(o){null!=o&&Object.keys(o).length>0&&"function"==typeof o.click&&o.click()}async function getStorageQuotaText(){if(!navigator.storage||"function"!=typeof navigator.storage.estimate)return console.warn("navigator.storage.estimate is not supported in this browser or context."),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"};try{const o=await navigator.storage.estimate(),e=+(o.quota||0),t=+(o.usage||0),n=e-t;return{totalQuota:formatAsByteString(e),usedQuota:formatAsByteString(t),freeQuota:formatAsByteString(n)}}catch(o){return console.error("Error estimating storage:",o),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"}}}async function log4quota(){const{totalQuota:o,usedQuota:e,freeQuota:t}=await getStorageQuotaText();let n=await countAllRecords(storeName);document.getElementById("idbQuotaTotal").textContent=`${o} , ${n}`,document.getElementById("idbQuotaUsed").textContent=e,console.log("freeQuota: "+t)}async function fetchAudioAsBlob(o){try{const e=await fetch(o);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.blob()}catch(o){throw console.error("Error fetching audio from URL:",o),o}}function saveAudioBlob(o,e){if(!idb4songs)throw new Error("Database not open.");const t=idb4songs.transaction([storeName],"readwrite"),n=t.objectStore(storeName),r={[storeKey]:e,data:o,timestamp:Date.now(),mimeType:o.type,size:o.size},a=n.put(r);a.onsuccess=()=>{console.log(`Audio Blob (${o.size}) for key '${e}' saved successfully!`)},a.onerror=o=>{console.error(`Error saving Blob/${e}:`,o.target.error)},t.oncomplete=()=>{console.log("Transaction completed.")}}async function saveUrlContentToDB(o,e){console.log(`Start downloading for ${e}: ${o}`);try{const t=await fetchAudioAsBlob(o);console.log(`Download complete. Blob size: ${t.size} bytes`),saveAudioBlob(t,e)}catch(t){console.error(`Failed to fetch&save audio for key/url ${e}/${o}:`,t)}}function keyExists(o){return new Promise((e,t)=>{if(!idb4songs)return void t(new Error("Database not initialized."));const n=idb4songs.transaction([storeName],"readonly").objectStore(storeName).count(o);n.onerror=o=>{console.error("Error counting key:",o.target.error),t(o.target.error)},n.onsuccess=t=>{const n=t.target.result;console.log(`count(${o})= ${n}`),e(n>0)}})}function countAllRecords(o){return new Promise((e,t)=>{const n=idb4songs.transaction([o],"readonly").objectStore(o).count();n.onsuccess=o=>{const t=o.target.result;e(t)},n.onerror=o=>{t("Error counting records: "+o.target.error)}})}async function loadAudioBlob(o){return new Promise((e,t)=>{const n=idb4songs.transaction(storeName,"readonly").objectStore(storeName).get(o);n.onsuccess=()=>e(n.result||null),n.onerror=()=>t(n.error)})}async function url4cachedSong(o,e,t){if(!e.match(/\/xmusic.*/i))return t;let n=null;try{if(0==await keyExists(e)&&(console.log(`Audio not cached yet for '${e}', will download and cache it now if ${o}>0`),o&&await saveUrlContentToDB(t,e)),!(await keyExists(e)>0))return t;if(n=await loadAudioBlob(e),null!=n)return URL.createObjectURL(n.data);throw new Error("I cannot believe aBlob is still null, sth wrong with the downloading !!!")}catch(o){return console.error(`Failed to load/download audio for song fn|sUrl '${e}'|${t}:`,o),t}}async function updateSong2local(o,e){let t=o.url,n=new URL(t),r=decodeURI(n.pathname);return console.log(`trying to cache song '${r}'`),o.url=await url4cachedSong(e,r,t),o}function updateSongsURL2local(o,e){let t=o;return t.forEach(async function(o){await updateSong2local(o,e).then(o=>{console.log(`Updated song URL for '${o.name}': ${o.url}`)})}),t}var songIdx=randomInt(0,max10),jsonUrl=`https://storage.googleapis.com/xpub/playlists/${String(songIdx).padStart(8,"0")}.json`,nSongs=getParam("x",10);nSongs>10&&(songIdx=0,jsonUrl="https://storage.googleapis.com/xpub/playlists/all.json"),console.log(`nSongs=${nSongs} , jsonUrl=${jsonUrl}`);const storeName="xLocalIDB",storeKey="fileName",dbVersion=1;var idb4songs=null;const formatAsByteString=o=>{const e=1073741824,t=1048576,n=1024;return o>e?`${(o/e).toFixed(1)} GB`:o>t?`${(o/t).toFixed(1)} MB`:`${(o/n).toFixed(1)}KB`},openIndexedDb=(o,e)=>new Promise((t,n)=>{const r=indexedDB.open(o,1);r.onerror=o=>{n(o.target.error)},r.onsuccess=n=>{console.log(`indexedDB ${o}/${e} opened successfully`),t(n.target.result)},r.onupgradeneeded=o=>{e.forEach(e=>{o.target.result.createObjectStore(e.name,{keyPath:e.keyPath}).createIndex(e.keyPath,e.keyPath,{unique:!0})})}});window.addEventListener("load",async()=>{idb4songs=await openIndexedDb("xdb4songs",[{name:storeName,keyPath:storeKey}]),json2array(jsonUrl).then(async o=>{if(o){o=updateSongsURL2local(o,0),console.log("Cached songs: ",o);var e=new APlayer({id4audio:"xAudio",element:document.getElementById("xplayer"),narrow:!1,mini:!1,autoplay:!1,loop:"all",order:"random",volume:1,preload:"auto",showlrc:!1,lrctype:3,mutex:!0,theme:"#ad7a86",listFolded:!0,audio:getRandomSubarray(o,nSongs)});e.audio.addEventListener("play",async function(){let o=e.list.audios[e.list.index];await updateSong2local(o,nSongs<=10);var t=o.name,n=o.artist;console.log(`play event of song/${e.list.index} : ${t} | ${n} | ${e.list.audios[e.list.index].url} `);var r=$("#xplayer");if(r.length){document.title=n+" | "+t;var a=r[0].querySelector("time"),s=1;if(a){var l=new Date(a.getAttribute("datetime")).getTime();s=((new Date).getTime()-l)/6e4}else{var i=document.createElement("time");i.setAttribute("datetime",(new Date).toISOString()),i.style.display="none",r[0].appendChild(i),a=i}if(s>=1)safeObjClick($("#page4pixabay")[0]),a.setAttribute("datetime",(new Date).toISOString())}}),e.on("loadeddata",function(){console.log("loadeddata of song: "+e.list.index),console.log("URL: "+e.list.audios[e.list.index].url),console.log(e.list.audios[e.list.index]),console.log("src: "+e.audio.src),console.log(e.audio.buffered)})}});const o=$("#xplayer").parent(),e=$(".pixabay_widget");e.length&&e.prependTo(o),await log4quota()});