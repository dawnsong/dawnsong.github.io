"use strict";function randomInt(o,e){return Math.floor(Math.random()*(e-o+1)+o)}async function json2array(o){console.log(`Fetching JSON from ${o} ...`);try{const e=await fetch(o);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}catch(e){throw console.error(`Fetching JSON (${o}) failed:`,e),e}}function getParam(o,e){const t=new URLSearchParams(window.location.search).get(o);return null!==t?t:e}async function idb2dataArray(o,e){return new Promise((t,n)=>{const r=o.transaction([e],"readonly"),a=r.objectStore(e),s=[];a.openCursor().onsuccess=o=>{const e=o.target.result;if(e){let o=e.value,t=o.fileName.split("/").pop().replace(/\.[^/.]+$/,"");o.artist=t.split("__")[0],o.name=t.split("__")[1],o.size=formatAsByteString(o.size),s.push(o),e.continue()}else try{t(s)}catch(o){n(`Error converting allRecords to JSON: ${o}`)}},r.onerror=o=>{n(`Transaction error: ${o.target.errorCode}`)}})}function url4jsonArray(o){const e=new Blob([o],{type:"application/json"});return URL.createObjectURL(e)}function getRandomSubarray(o,e){if(e>o.length&&(e=o.length),pRandom<=0||0==songIdx)return o.slice(0,e);for(var t,n,r=o.slice(0),a=o.length,s=a-e;a-- >s;)t=r[n=Math.floor((a+1)*Math.random())],r[n]=r[a],r[a]=t;return r.slice(s)}function moveDivToUl(){$("div.page__footer-follow > ul.social-icons > li:nth-child(1)").css("color","red")}function safeObjClick(o){null!=o&&Object.keys(o).length>0&&"function"==typeof o.click&&o.click()}async function getStorageQuotaText(){if(!navigator.storage||"function"!=typeof navigator.storage.estimate)return console.warn("navigator.storage.estimate is not supported in this browser or context."),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"};try{const o=await navigator.storage.estimate(),e=+(o.quota||0),t=+(o.usage||0),n=e-t;return{totalQuota:formatAsByteString(e),usedQuota:formatAsByteString(t),freeQuota:formatAsByteString(n)}}catch(o){return console.error("Error estimating storage:",o),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"}}}async function log4quota(){const{totalQuota:o,usedQuota:e,freeQuota:t}=await getStorageQuotaText();let n=await countAllRecords(storeName);document.getElementById("idbQuotaTotal").textContent=`${n}`,document.getElementById("idbQuotaUsed").textContent=e,console.log("freeQuota: "+t)}async function fetchAudioAsBlob(o){try{const e=await fetch(o);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.blob()}catch(o){throw console.error("Error fetching audio from URL:",o),o}}function saveAudioBlob(o,e,t){if(!idb4songs)throw new Error("Database not open.");const n=idb4songs.transaction([storeName],"readwrite"),r=n.objectStore(storeName);delete t.url;const a={[storeKey]:e,data:o,timestamp:Date.now(),mimeType:o.type,size:o.size,meta:t||{}},s=r.put(a);s.onsuccess=()=>{console.log(`Audio Blob (${o.size}) for key '${e}' saved successfully!`)},s.onerror=o=>{console.error(`Error saving Blob/${e}:`,o.target.error)},n.oncomplete=()=>{console.log("Transaction completed.")}}async function saveUrlContentToDB(o,e,t){console.log(`Start downloading for ${e}: ${o}`);try{const n=await fetchAudioAsBlob(o);console.log(`Download complete. Blob size: ${n.size} bytes`),saveAudioBlob(n,e,t)}catch(t){console.error(`Failed to fetch&save audio for key/url ${e}/${o}:`,t)}}function keyExists(o){return new Promise((e,t)=>{if(!idb4songs)return void t(new Error("Database not initialized."));const n=idb4songs.transaction([storeName],"readonly").objectStore(storeName).count(o);n.onerror=o=>{console.error("Error counting key:",o.target.error),t(o.target.error)},n.onsuccess=t=>{const n=t.target.result;console.log(`count(${o})= ${n}`),e(n>0)}})}function rmKey(o){return new Promise((e,t)=>{if(!idb4songs)return void t(new Error("Database not initialized."));const n=idb4songs.transaction([storeName],"readwrite").objectStore(storeName).delete(o);n.onerror=o=>{console.error("Error deleting key:",o.target.error),t(o.target.error)},n.onsuccess=()=>{console.log(`Key '${o}' deleted successfully.`),e()}})}function countAllRecords(o){return new Promise((e,t)=>{const n=idb4songs.transaction([o],"readonly").objectStore(o).count();n.onsuccess=o=>{const t=o.target.result;e(t)},n.onerror=o=>{t("Error counting records: "+o.target.error)}})}async function loadAudioBlob(o){return new Promise((e,t)=>{const n=idb4songs.transaction(storeName,"readonly").objectStore(storeName).get(o);n.onsuccess=()=>e(n.result||null),n.onerror=()=>t(n.error)})}async function url4cachedSong(o,e,t,n){if(!e.match(/\/xmusic.*/i))return t;let r=null;try{if(0==await keyExists(e)&&(console.log(`Audio not cached yet for '${e}', will download and cache it now if ${o}>0`),o&&await saveUrlContentToDB(t,e,n)),!(await keyExists(e)>0))return t;if(r=await loadAudioBlob(e),null!=r)return URL.createObjectURL(r.data);throw new Error("I cannot believe aBlob is still null, sth wrong with the downloading !!!")}catch(o){return console.error(`Failed to load/download audio for song fn|sUrl '${e}'|${t}:`,o),t}}async function updateSong2local(o,e){let t=o.url;try{let n=new URL(t),r=decodeURI(n.pathname);console.log(`trying to cache song '${r}'`),o.url=await url4cachedSong(e,r,t,o)}catch(e){console.error(`Failed to update song URL to local indexedDB for '${o.name}':`,e)}return o}function updateSongsURL2local(o,e){let t=o;return t.forEach(async function(o){await updateSong2local(o,e).then(o=>{console.log(`Updated song URL for '${o.name}': ${o.url}`)})}),t}let ap=null;const storeName="xLocalIDB",storeKey="fileName",dbVersion=1;var idb4songs=null,songIdx=randomInt(0,max10),nSongs=getParam("x",10);nSongs>10&&(songIdx=0,pPlaylist="all");var pPlaylist=getParam("playlist","random");console.log(`Initial pPlaylist=${pPlaylist}`),"random"==pPlaylist&&(pPlaylist=String(songIdx).padStart(8,"0"));var jsonUrl=`https://storage.googleapis.com/xpub/playlists/${pPlaylist}.json`,pRandom=getParam("r",1);0==pRandom&&(songIdx=0),console.log(`nSongs=${nSongs} , jsonUrl=${jsonUrl} , pRandom=${pRandom} , pPlaylist=${pPlaylist} `);const formatAsByteString=o=>{const e=1073741824,t=1048576,n=1024;return o>e?`${(o/e).toFixed(1)} GB`:o>t?`${(o/t).toFixed(1)} MB`:`${(o/n).toFixed(1)}KB`},openIndexedDb=(o,e)=>new Promise((t,n)=>{const r=indexedDB.open(o,1);r.onerror=o=>{n(o.target.error)},r.onsuccess=n=>{console.log(`indexedDB ${o}/${e} opened successfully`),t(n.target.result)},r.onupgradeneeded=o=>{e.forEach(e=>{o.target.result.createObjectStore(e.name,{keyPath:e.keyPath}).createIndex(e.keyPath,e.keyPath,{unique:!0})})}});window.addEventListener("load",async()=>{if(idb4songs=await openIndexedDb("xdb4songs",[{name:storeName,keyPath:storeKey}]),"offline"==pPlaylist){let o=await idb2dataArray(idb4songs,storeName);console.log("allSongs from IndexedDB: ",o),jsonUrl=url4jsonArray(JSON.stringify(o))}json2array(jsonUrl).then(async o=>{o&&(o=updateSongsURL2local(getRandomSubarray(o,nSongs),0),console.log("Cached songs: ",o),ap=new APlayer({id4audio:"xAudio",element:document.getElementById("xplayer"),narrow:!1,mini:!1,autoplay:!1,loop:"all",order:0!=pRandom||0!=songIdx?"random":"list",volume:1,preload:"none",showlrc:!1,lrctype:3,mutex:!0,theme:"#ad7a86",listFolded:!0,audio:o}),ap.audio.addEventListener("play",async function(){let o=ap.list.audios[ap.list.index];await updateSong2local(o,nSongs>0);var e=o.name,t=o.artist;console.log(`play event of song/${ap.list.index} : ${e} | ${t} | ${ap.list.audios[ap.list.index].url} `);var n=$("#xplayer");if(n.length){document.title=t+" | "+e;var r=n[0].querySelector("time"),a=1;if(r){var s=new Date(r.getAttribute("datetime")).getTime();a=((new Date).getTime()-s)/6e4}else{var l=document.createElement("time");l.setAttribute("datetime",(new Date).toISOString()),l.style.display="none",n[0].appendChild(l),r=l}if(a>=1)safeObjClick($("#page4pixabay")[0]),r.setAttribute("datetime",(new Date).toISOString());await log4quota()}}),ap.on("loadeddata",async function(){console.log("loadeddata of song: "+ap.list.index),console.log("URL: "+ap.list.audios[ap.list.index].url),console.log(ap.list.audios[ap.list.index]),console.log("src: "+ap.audio.src),console.log(ap.audio.buffered)}))});const o=$("#xplayer").parent(),e=$(".pixabay_widget");e.length&&e.prependTo(o),await log4quota()});