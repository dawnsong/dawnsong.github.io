"use strict";function randomInt(t,e){return Math.floor(Math.random()*(e-t+1)+t)}async function json2array(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}catch(t){throw t}}function getParam(t,e){const o=new URLSearchParams(window.location.search).get(t);return null!==o?o:e}async function idb2dataArray(t,e){return new Promise((o,a)=>{const n=t.transaction([e],"readonly"),r=n.objectStore(e),s=[];r.openCursor().onsuccess=t=>{const e=t.target.result;if(e){let t=e.value,o=t.fileName.split("/").pop().replace(/\.[^/.]+$/,"");t.artist=o.split("__")[0],t.name=o.split("__")[1],t.size=formatAsByteString(t.size),s.push(t),e.continue()}else try{o(s)}catch(t){a(`Error converting allRecords to JSON: ${t}`)}},n.onerror=t=>{a(`Transaction error: ${t.target.errorCode}`)}})}function url4jsonArray(t){const e=new Blob([t],{type:"application/json"});return URL.createObjectURL(e)}function getRandomSubarray(t,e){if(e>t.length&&(e=t.length),pRandom<=0||0==songIdx)return t.slice(0,e);for(var o,a,n=t.slice(0),r=t.length,s=r-e;r-- >s;)o=n[a=Math.floor((r+1)*Math.random())],n[a]=n[r],n[r]=o;return n.slice(s)}function moveDivToUl(){$("div.page__footer-follow > ul.social-icons > li:nth-child(1)").css("color","red")}function safeObjClick(t){null!=t&&Object.keys(t).length>0&&"function"==typeof t.click&&t.click()}async function getStorageQuotaText(){if(!navigator.storage||"function"!=typeof navigator.storage.estimate)return{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"};try{const t=await navigator.storage.estimate(),e=+(t.quota||0),o=+(t.usage||0),a=e-o;return{totalQuota:formatAsByteString(e),usedQuota:formatAsByteString(o),freeQuota:formatAsByteString(a)}}catch(t){return{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"}}}async function log4quota(){const{totalQuota:t,usedQuota:e,freeQuota:o}=await getStorageQuotaText();let a=await countAllRecords(storeName);document.getElementById("idbQuotaTotal").textContent=`${a}`,document.getElementById("idbQuotaUsed").textContent=e}async function fetchAudioAsBlob(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.blob()}catch(t){throw t}}function saveAudioBlob(t,e,o){if(!idb4songs)throw new Error("Database not open.");const a=idb4songs.transaction([storeName],"readwrite"),n=a.objectStore(storeName);delete o.url;const r={[storeKey]:e,data:t,timestamp:Date.now(),mimeType:t.type,size:t.size,meta:o||{}},s=n.put(r);s.onsuccess=()=>{},s.onerror=()=>{},a.oncomplete=()=>{}}async function saveUrlContentToDB(t,e,o){try{const a=await fetchAudioAsBlob(t);saveAudioBlob(a,e,o)}catch(t){}}function keyExists(t){return new Promise((e,o)=>{if(!idb4songs)return void o(new Error("Database not initialized."));const a=idb4songs.transaction([storeName],"readonly").objectStore(storeName).count(t);a.onerror=t=>{o(t.target.error)},a.onsuccess=t=>{const o=t.target.result;e(o>0)}})}function rmKey(t){return new Promise((e,o)=>{if(!idb4songs)return void o(new Error("Database not initialized."));const a=idb4songs.transaction([storeName],"readwrite").objectStore(storeName).delete(t);a.onerror=t=>{o(t.target.error)},a.onsuccess=()=>{e()}})}function countAllRecords(t){return new Promise((e,o)=>{const a=idb4songs.transaction([t],"readonly").objectStore(t).count();a.onsuccess=t=>{const o=t.target.result;e(o)},a.onerror=t=>{o("Error counting records: "+t.target.error)}})}async function loadAudioBlob(t){return new Promise((e,o)=>{const a=idb4songs.transaction(storeName,"readonly").objectStore(storeName).get(t);a.onsuccess=()=>e(a.result||null),a.onerror=()=>o(a.error)})}async function url4cachedSong(t,e,o,a){if(!e.match(/\/xmusic.*/i))return o;let n=null;try{if(0==await keyExists(e)&&t&&await saveUrlContentToDB(o,e,a),!(await keyExists(e)>0))return o;if(n=await loadAudioBlob(e),null!=n)return URL.createObjectURL(n.data);throw new Error("I cannot believe aBlob is still null, sth wrong with the downloading !!!")}catch(t){return o}}async function updateSong2local(t,e){let o=t.url;try{let a=new URL(o),n=decodeURI(a.pathname);t.url=await url4cachedSong(e,n,o,t)}catch(t){}return t}function updateSongsURL2local(t,e){let o=t;return o.forEach(async function(t){await updateSong2local(t,e).then(()=>{})}),o}let ap=null;const storeName="xLocalIDB",storeKey="fileName",dbVersion=1;var idb4songs=null,songIdx=randomInt(0,max10),nSongs=getParam("x",10);nSongs>10&&(songIdx=0,pPlaylist="all");var pPlaylist=getParam("playlist","random");"random"==pPlaylist&&(pPlaylist=String(songIdx).padStart(8,"0"));var jsonUrl=`https://storage.googleapis.com/xpub/playlists/${pPlaylist}.json`,pRandom=getParam("r",1);0==pRandom&&(songIdx=0);const formatAsByteString=t=>{const e=1073741824,o=1048576,a=1024;return t>e?`${(t/e).toFixed(1)} GB`:t>o?`${(t/o).toFixed(1)} MB`:`${(t/a).toFixed(1)}KB`},openIndexedDb=(t,e)=>new Promise((o,a)=>{const n=indexedDB.open(t,1);n.onerror=t=>{a(t.target.error)},n.onsuccess=t=>{o(t.target.result)},n.onupgradeneeded=t=>{e.forEach(e=>{t.target.result.createObjectStore(e.name,{keyPath:e.keyPath}).createIndex(e.keyPath,e.keyPath,{unique:!0})})}});window.addEventListener("load",async()=>{if(idb4songs=await openIndexedDb("xdb4songs",[{name:storeName,keyPath:storeKey}]),"offline"==pPlaylist){let t=await idb2dataArray(idb4songs,storeName),e=Array(t.length).fill({}),o=0;await Promise.all(t.map(async t=>{let a=await loadAudioBlob(t.fileName),n={};n.name=t.name,n.artist=t.artist,n.url="",n.cover="",n.meta=t.meta||{},null!=a&&(n.url=URL.createObjectURL(a.data)),e[o++]=n})),jsonUrl=url4jsonArray(JSON.stringify(e))}json2array(jsonUrl).then(async t=>{t&&(t=updateSongsURL2local(getRandomSubarray(t,nSongs),0),ap=new APlayer({id4audio:"xAudio",element:document.getElementById("xplayer"),narrow:!1,mini:!1,autoplay:!1,loop:"all",order:0!=pRandom||0!=songIdx?"random":"list",volume:1,preload:"none",showlrc:!1,lrctype:3,mutex:!0,theme:"#ad7a86",listFolded:!0,audio:t}),ap.audio.addEventListener("play",async function(){let t=ap.list.audios[ap.list.index];await updateSong2local(t,nSongs>0);var e=t.name,o=t.artist,a=$("#xplayer");if(a.length){document.title=o+" | "+e;var n=a[0].querySelector("time"),r=1;if(n){var s=new Date(n.getAttribute("datetime")).getTime();r=((new Date).getTime()-s)/6e4}else{var i=document.createElement("time");i.setAttribute("datetime",(new Date).toISOString()),i.style.display="none",a[0].appendChild(i),n=i}if(r>=1)safeObjClick($("#page4pixabay")[0]),n.setAttribute("datetime",(new Date).toISOString());await log4quota()}}),ap.on("loadeddata",async function(){}))});const t=$("#xplayer").parent(),e=$(".pixabay_widget");e.length&&e.prependTo(t),await log4quota()});