"use strict";function randomInt(t,e){return Math.floor(Math.random()*(e-t+1)+t)}async function json2array(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}catch(t){throw console.error("Fetching JSON failed:",t),t}}function getParam(t,e){const o=new URLSearchParams(window.location.search).get(t);return null!==o?o:e}function getRandomSubarray(t,e){e>t.length&&(e=t.length);for(var o,a,n=t.slice(0),r=t.length,s=r-e;r-- >s;)o=n[a=Math.floor((r+1)*Math.random())],n[a]=n[r],n[r]=o;return n.slice(s)}function moveDivToUl(){$("div.page__footer-follow > ul.social-icons > li:nth-child(1)").css("color","red")}function safeObjClick(t){null!=t&&Object.keys(t).length>0&&"function"==typeof t.click&&t.click()}async function getStorageQuotaText(){if(!navigator.storage||"function"!=typeof navigator.storage.estimate)return console.warn("navigator.storage.estimate is not supported in this browser or context."),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"};try{const t=await navigator.storage.estimate(),e=+(t.quota||0),o=+(t.usage||0),a=e-o;return{totalQuota:formatAsByteString(e),usedQuota:formatAsByteString(o),freeQuota:formatAsByteString(a)}}catch(t){return console.error("Error estimating storage:",t),{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"}}}async function log4quota(){const{totalQuota:t,usedQuota:e,freeQuota:o}=await getStorageQuotaText();document.getElementById("idbQuotaTotal").textContent=t,document.getElementById("idbQuotaUsed").textContent=e,console.log("freeQuota: "+o)}function updateSongsURL2local(t){t.forEach(function(t){console.log(t)})}var songIdx=randomInt(0,max10),jsonUrl=`https://storage.googleapis.com/xpub/playlists/${String(songIdx).padStart(8,"0")}.json`,nSongs=getParam("x",10);nSongs>10&&(songIdx=0,jsonUrl="https://storage.googleapis.com/xpub/playlists/all.json"),console.log(jsonUrl);const storeName="xLocalIDB",storeKey="fileName",dbVersion=1;let idb4songs=null;const formatAsByteString=t=>{const e=1073741824,o=1048576,a=1024;return t>e?`${(t/e).toFixed(1)} GB`:t>o?`${(t/o).toFixed(1)} MB`:`${(t/a).toFixed(1)}KB`},initIndexedDb=(t,e)=>new Promise((o,a)=>{const n=indexedDB.open(t,1);n.onerror=t=>{console.error("indexedDB error: "+t.target.errorCode),a(t.target.error)},n.onsuccess=t=>{t.target.result;console.log("indexedDB opened successfully"),o(t.target.result)},n.onupgradeneeded=t=>{e.forEach(e=>{t.target.result.createObjectStore(e.name,{keyPath:e.keyPath}).createIndex(e.keyPath,e.keyPath,{unique:!0})})}});window.addEventListener("load",async()=>{idb4songs=await initIndexedDb("xdb4songs",[{name:storeName,keyPath:storeKey}]),json2array(jsonUrl).then(t=>{if(t){updateSongsURL2local(t),console.log("Cached songs: ",t);var e=new APlayer({id4audio:"xAudio",element:document.getElementById("xplayer"),narrow:!1,mini:!1,autoplay:!1,loop:"all",order:"random",volume:1,preload:"auto",showlrc:!1,lrctype:3,mutex:!0,theme:"#ad7a86",listFolded:!0,audio:getRandomSubarray(t,nSongs)});e.audio.addEventListener("play",function(){var t=e.list.audios[e.list.index].name,o=e.list.audios[e.list.index].artist;console.log("Started playing: "+t+" | "+o);var a=$("#xplayer");if(a.length){document.title=o+" | "+t;var n=a[0].querySelector("time"),r=1;if(n){var s=new Date(n.getAttribute("datetime")).getTime();r=((new Date).getTime()-s)/6e4}else{var i=document.createElement("time");i.setAttribute("datetime",(new Date).toISOString()),i.style.display="none",a[0].appendChild(i),n=i}if(r>=1)safeObjClick($("#page4pixabay")[0]),n.setAttribute("datetime",(new Date).toISOString())}}),e.on("loadeddata",function(){console.log("loadeddata of song: "+e.list.index),console.log("URL: "+e.list.audios[e.list.index].url),console.log(e.list.audios[e.list.index]),console.log("src: "+e.audio.src),console.log(e.audio.buffered)})}});const t=$("#xplayer").parent(),e=$(".pixabay_widget");e.length&&e.prependTo(t),await log4quota()});