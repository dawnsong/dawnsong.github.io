"use strict";function randomInt(t,e){return Math.floor(Math.random()*(e-t+1)+t)}async function json2array(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}catch(t){throw t}}function getParam(t,e){const o=new URLSearchParams(window.location.search).get(t);return null!==o?o:e}function getRandomSubarray(t,e){e>t.length&&(e=t.length);for(var o,a,n=t.slice(0),r=t.length,s=r-e;r-- >s;)o=n[a=Math.floor((r+1)*Math.random())],n[a]=n[r],n[r]=o;return n.slice(s)}function moveDivToUl(){$("div.page__footer-follow > ul.social-icons > li:nth-child(1)").css("color","red")}function safeObjClick(t){null!=t&&Object.keys(t).length>0&&"function"==typeof t.click&&t.click()}async function getStorageQuotaText(){if(!navigator.storage||"function"!=typeof navigator.storage.estimate)return{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"};try{const t=await navigator.storage.estimate(),e=+(t.quota||0),o=+(t.usage||0),a=e-o;return{totalQuota:formatAsByteString(e),usedQuota:formatAsByteString(o),freeQuota:formatAsByteString(a)}}catch(t){return{totalQuota:"NA",usedQuota:"NA",freeQuota:"NA"}}}async function log4quota(){const{totalQuota:t,usedQuota:e,freeQuota:o}=await getStorageQuotaText();let a=await countAllRecords(storeName);document.getElementById("idbQuotaTotal").textContent=`${t} , ${a}`,document.getElementById("idbQuotaUsed").textContent=e}async function fetchAudioAsBlob(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.blob()}catch(t){throw t}}function saveAudioBlob(t,e){if(!idb4songs)throw new Error("Database not open.");const o=idb4songs.transaction([storeName],"readwrite"),a=o.objectStore(storeName),n={[storeKey]:e,data:t,timestamp:Date.now(),mimeType:t.type,size:t.size},r=a.put(n);r.onsuccess=()=>{},r.onerror=()=>{},o.oncomplete=()=>{}}async function saveUrlContentToDB(t,e){try{const o=await fetchAudioAsBlob(t);saveAudioBlob(o,e)}catch(t){}}function keyExists(t){return new Promise((e,o)=>{if(!idb4songs)return void o(new Error("Database not initialized."));const a=idb4songs.transaction([storeName],"readonly").objectStore(storeName).count(t);a.onerror=t=>{o(t.target.error)},a.onsuccess=t=>{const o=t.target.result;e(o>0)}})}function countAllRecords(t){return new Promise((e,o)=>{const a=idb4songs.transaction([t],"readonly").objectStore(t).count();a.onsuccess=t=>{const o=t.target.result;e(o)},a.onerror=t=>{o("Error counting records: "+t.target.error)}})}async function loadAudioBlob(t){return new Promise((e,o)=>{const a=idb4songs.transaction(storeName,"readonly").objectStore(storeName).get(t);a.onsuccess=()=>e(a.result||null),a.onerror=()=>o(a.error)})}async function url4cachedSong(t,e,o){if(!e.match(/\/xmusic.*/i))return o;let a=null;try{if(0==await keyExists(e)&&t&&await saveUrlContentToDB(o,e),!(await keyExists(e)>0))return o;if(a=await loadAudioBlob(e),null!=a)return URL.createObjectURL(a.data);throw new Error("I cannot believe aBlob is still null, sth wrong with the downloading !!!")}catch(t){return o}}async function updateSong2local(t,e){let o=t.url,a=new URL(o),n=decodeURI(a.pathname);return t.url=await url4cachedSong(e,n,o),t}function updateSongsURL2local(t,e){let o=t;return o.forEach(async function(t){await updateSong2local(t,e).then(()=>{})}),o}var songIdx=randomInt(0,max10),jsonUrl=`https://storage.googleapis.com/xpub/playlists/${String(songIdx).padStart(8,"0")}.json`,nSongs=getParam("x",10);nSongs>10&&(songIdx=0,jsonUrl="https://storage.googleapis.com/xpub/playlists/all.json");const storeName="xLocalIDB",storeKey="fileName",dbVersion=1;var idb4songs=null;const formatAsByteString=t=>{const e=1073741824,o=1048576,a=1024;return t>e?`${(t/e).toFixed(1)} GB`:t>o?`${(t/o).toFixed(1)} MB`:`${(t/a).toFixed(1)}KB`},openIndexedDb=(t,e)=>new Promise((o,a)=>{const n=indexedDB.open(t,1);n.onerror=t=>{a(t.target.error)},n.onsuccess=t=>{o(t.target.result)},n.onupgradeneeded=t=>{e.forEach(e=>{t.target.result.createObjectStore(e.name,{keyPath:e.keyPath}).createIndex(e.keyPath,e.keyPath,{unique:!0})})}});window.addEventListener("load",async()=>{idb4songs=await openIndexedDb("xdb4songs",[{name:storeName,keyPath:storeKey}]),json2array(jsonUrl).then(async t=>{if(t){t=updateSongsURL2local(t,0);var e=new APlayer({id4audio:"xAudio",element:document.getElementById("xplayer"),narrow:!1,mini:!1,autoplay:!1,loop:"all",order:"random",volume:1,preload:"auto",showlrc:!1,lrctype:3,mutex:!0,theme:"#ad7a86",listFolded:!0,audio:getRandomSubarray(t,nSongs)});e.audio.addEventListener("play",async function(){let t=e.list.audios[e.list.index];await updateSong2local(t,nSongs<=10);var o=t.name,a=t.artist,n=$("#xplayer");if(n.length){document.title=a+" | "+o;var r=n[0].querySelector("time"),s=1;if(r){var i=new Date(r.getAttribute("datetime")).getTime();s=((new Date).getTime()-i)/6e4}else{var c=document.createElement("time");c.setAttribute("datetime",(new Date).toISOString()),c.style.display="none",n[0].appendChild(c),r=c}if(s>=1)safeObjClick($("#page4pixabay")[0]),r.setAttribute("datetime",(new Date).toISOString());await log4quota()}}),e.on("loadeddata",async function(){})}});const t=$("#xplayer").parent(),e=$(".pixabay_widget");e.length&&e.prependTo(t),await log4quota()});